name: Publish revnext to PyPI

on:
    push:
        branches: [main, master]
        paths:
            - 'packages/revnext/pyproject.toml'

jobs:
    publish:
        runs-on: ubuntu-latest
        permissions:
            contents: write # push tags and create releases
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  # PAT required: GITHUB_TOKEN cannot push tags when the commit touches .github/workflows
                  token: ${{ secrets.REPO_ACCESS_TOKEN }}
            - name: Get version
              id: version
              run: |
                  V=$(grep '^version' packages/revnext/pyproject.toml | sed -n 's/version *= *"\([^"]*\)".*/\1/p')
                  echo "version=$V" >> $GITHUB_OUTPUT
            - name: Skip if tag already exists
              id: check
              run: |
                  git fetch --tags
                  if git rev-parse "revnext-v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                  fi
            - name: Create and push tag
              if: steps.check.outputs.exists == 'false'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  TAG="revnext-v${{ steps.version.outputs.version }}"
                  git tag "$TAG"
                  git push origin "$TAG"
            - uses: actions/setup-python@v5
              with:
                  python-version: '3.14'
            - name: Install build
              run: pip install build twine
            - name: Build revnext
              if: steps.check.outputs.exists == 'false'
              run: python -m build
              working-directory: packages/revnext
            - name: Publish to PyPI
              if: steps.check.outputs.exists == 'false'
              env:
                  TWINE_USERNAME: __token__
                  TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
              run: twine upload packages/revnext/dist/*
            - name: Create GitHub Release
              if: steps.check.outputs.exists == 'false'
              env:
                  GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
              run: |
                  TAG="revnext-v${{ steps.version.outputs.version }}"
                  PREV=$(git tag -l 'revnext-v*' --sort=-v:refname | sed -n '2p')
                  echo "## Commits" > commit-notes.md
                  if [ -n "$PREV" ]; then
                    git log "$PREV"..HEAD --pretty=format:"- %s (%h)" -- packages/revnext >> commit-notes.md 2>/dev/null || true
                  else
                    git log --pretty=format:"- %s (%h)" -- packages/revnext >> commit-notes.md 2>/dev/null || true
                  fi
                  NOTES_OPT=$( [ -n "$PREV" ] && echo "--notes-start-tag $PREV" || true )
                  gh release create "$TAG" --generate-notes $NOTES_OPT --notes-file commit-notes.md
